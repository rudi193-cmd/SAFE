<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Willow System Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #00ff00; margin-bottom: 10px; font-size: 24px; }
        h2 { color: #00cc00; margin-top: 30px; margin-bottom: 15px; font-size: 18px; border-bottom: 1px solid #00ff00; padding-bottom: 5px; }
        h3 { color: #00aa00; margin-top: 20px; margin-bottom: 10px; font-size: 16px; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .status-bar { display: flex; gap: 20px; }
        .status-item { padding: 8px 15px; background: #111; border: 1px solid #00ff00; border-radius: 4px; }
        .status-healthy { border-color: #00ff00; color: #00ff00; }
        .status-warning { border-color: #ffaa00; color: #ffaa00; }
        .status-critical { border-color: #ff0000; color: #ff0000; }

        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .panel { background: #111; border: 1px solid #00ff00; padding: 15px; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
        .panel:hover { border-color: #00ff00; box-shadow: 0 0 10px rgba(0, 255, 0, 0.3); transform: translateY(-2px); }
        .panel-full { grid-column: 1 / -1; }
        .panel-compact { min-height: 140px; display: flex; flex-direction: column; justify-content: space-between; }
        .card-title { font-size: 18px; margin-bottom: 10px; }
        .card-stats { font-size: 14px; color: #00cc00; margin: 5px 0; }
        .card-action { margin-top: 10px; padding: 5px 10px; background: #003300; border: 1px solid #00ff00; color: #00ff00; cursor: pointer; font-size: 12px; }
        .card-action:hover { background: #00ff00; color: #000; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #333; }
        th { color: #00ff00; font-weight: bold; }
        td { color: #00aa00; }

        .metric { display: flex; justify-content: space-between; padding: 5px 0; }
        .metric-label { color: #00cc00; }
        .metric-value { color: #00ff00; font-weight: bold; }

        .anomaly { background: #1a0000; border-left: 3px solid #ff0000; padding: 10px; margin: 10px 0; }
        .anomaly.medium { background: #1a1000; border-color: #ffaa00; }
        .anomaly.low { background: #001a00; border-color: #00ff00; }

        .suggestion { background: #001a00; border-left: 3px solid #00ff00; padding: 10px; margin: 10px 0; }
        .suggestion button { background: #00ff00; color: #000; border: none; padding: 5px 15px; cursor: pointer; border-radius: 3px; margin-left: 10px; }
        .suggestion button:hover { background: #00cc00; }

        .refresh-btn { background: #00ff00; color: #000; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; font-family: 'Courier New', monospace; font-weight: bold; }
        .refresh-btn:hover { background: #00cc00; }

        .timestamp { color: #666; font-size: 12px; }
        .icon { margin-right: 5px; }

        .empty { color: #666; font-style: italic; padding: 20px; text-align: center; }

        /* Modal System */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: none;
            z-index: 1000;
        }
        .modal-overlay.show { display: block; }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 1200px;
            max-height: 85vh;
            background-color: #0a0a0a;
            padding: 30px;
            border: 2px solid #00ff00;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            overflow-y: auto;
            color: #00ff00;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #00ff00;
        }

        .modal-title { font-size: 24px; color: #00ff00; }

        .modal-close {
            background-color: #003300;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 8px 16px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .modal-close:hover { background: #00ff00; color: #000; }

        .modal-body { color: #00cc00; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üß† WILLOW SYSTEM DASHBOARD</h1>
                <p class="timestamp">Last updated: <span id="last-update">--</span></p>
            </div>
            <button class="refresh-btn" onclick="loadAll()">‚Üª Refresh</button>
        </div>

        <div class="status-bar" id="status-bar">
            <!-- Status indicators will be populated by JS -->
        </div>

        <div class="grid">
            <!-- Provider Mesh Card -->
            <div class="panel panel-compact" onclick="openModal('providers')">
                <div>
                    <h2 class="card-title">üåê Providers</h2>
                    <div class="card-stats" id="provider-summary">Loading...</div>
                </div>
                <button class="card-action">Details ‚Üí</button>
            </div>

            <!-- Queue Status Card -->
            <div class="panel panel-compact" onclick="openModal('queues')">
                <div>
                    <h2 class="card-title">üì• Queues</h2>
                    <div class="card-stats" id="queue-summary">Loading...</div>
                </div>
                <button class="card-action">Details ‚Üí</button>
            </div>

            <!-- Node Health Card -->
            <div class="panel panel-compact" onclick="openModal('nodes')">
                <div>
                    <h2 class="card-title">üå≥ Nodes</h2>
                    <div class="card-stats" id="node-summary">Loading...</div>
                </div>
                <button class="card-action">Details ‚Üí</button>
            </div>

            <!-- Learning Card -->
            <div class="panel panel-compact" onclick="openModal('learning')">
                <div>
                    <h2 class="card-title">üß† Learning</h2>
                    <div class="card-stats" id="learning-summary">Loading...</div>
                </div>
                <button class="card-action">Details ‚Üí</button>
            </div>

            <!-- Rules Card -->
            <div class="panel panel-compact" onclick="openModal('rules')">
                <div>
                    <h2 class="card-title">üí° Rules</h2>
                    <div class="card-stats" id="rules-summary">Loading...</div>
                </div>
                <button class="card-action">Details ‚Üí</button>
            </div>

            <!-- Patterns Card -->
            <div class="panel panel-compact" onclick="openModal('patterns')">
                <div>
                    <h2 class="card-title">üìä Patterns</h2>
                    <div class="card-stats" id="pattern-summary">Loading...</div>
                </div>
                <button class="card-action">Details ‚Üí</button>
            </div>
        </div>

        <!-- Modal Container -->
        <div id="modal-container" style="display: none;"></div>
    </div>

    <script>
        const API_BASE = '';  // Same origin

        function updateTimestamp() {
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        async function loadPatternStats() {
            try {
                const r = await fetch(`${API_BASE}/api/patterns/stats`);
                const data = await r.json();

                const html = `
                    <div class="metric">
                        <span class="metric-label">Total Routings (30d):</span>
                        <span class="metric-value">${data.total_routings || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Unresolved Anomalies:</span>
                        <span class="metric-value">${data.unresolved_anomalies || 0}</span>
                    </div>
                    <h3>Top Destinations</h3>
                    ${Object.entries(data.by_destination || {}).slice(0, 5).map(([dest, cnt]) =>
                        `<div class="metric"><span>${dest}</span><span>${cnt}</span></div>`
                    ).join('') || '<p class="empty">No data yet</p>'}
                `;
                document.getElementById('pattern-stats').innerHTML = html;
            } catch (e) {
                document.getElementById('pattern-stats').innerHTML = `<p class="empty">Error: ${e.message}</p>`;
            }
        }

        async function loadHealthOverview() {
            try {
                const r = await fetch(`${API_BASE}/api/health/issues`);
                const data = await r.json();
                const issues = data.issues || [];

                const critical = issues.filter(i => i.severity === 'critical').length;
                const high = issues.filter(i => i.severity === 'high').length;
                const medium = issues.filter(i => i.severity === 'medium').length;

                const html = `
                    <div class="metric">
                        <span class="metric-label">Critical Issues:</span>
                        <span class="metric-value" style="color: ${critical > 0 ? '#ff0000' : '#00ff00'}">${critical}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">High Issues:</span>
                        <span class="metric-value" style="color: ${high > 0 ? '#ff6600' : '#00ff00'}">${high}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Medium Issues:</span>
                        <span class="metric-value" style="color: ${medium > 0 ? '#ffaa00' : '#00ff00'}">${medium}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Total Unresolved:</span>
                        <span class="metric-value">${issues.length}</span>
                    </div>
                `;
                document.getElementById('health-overview').innerHTML = html;

                // Update status bar
                let statusClass = 'status-healthy';
                let statusText = 'HEALTHY';
                if (critical > 0) { statusClass = 'status-critical'; statusText = 'CRITICAL'; }
                else if (high > 0 || medium > 0) { statusClass = 'status-warning'; statusText = 'WARNING'; }

                document.getElementById('status-bar').innerHTML = `
                    <div class="status-item ${statusClass}">System: ${statusText}</div>
                    <div class="status-item">${issues.length} Unresolved Issues</div>
                `;
            } catch (e) {
                document.getElementById('health-overview').innerHTML = `<p class="empty">Error: ${e.message}</p>`;
            }
        }

        async function loadAnomalies() {
            try {
                const r = await fetch(`${API_BASE}/api/patterns/anomalies`);
                const data = await r.json();
                const anomalies = data.anomalies || [];

                if (anomalies.length === 0) {
                    document.getElementById('anomalies').innerHTML = '<p class="empty">No anomalies detected</p>';
                    return;
                }

                const html = anomalies.map((a, idx) => `
                    <div class="anomaly ${a.severity}">
                        <strong>${a.type}</strong>: ${a.description}<br>
                        <span class="timestamp">Affected: ${a.affected_nodes.join(', ')}</span>
                        <button onclick="dismissAnomaly('${a.id || idx}')">Dismiss</button>
                    </div>
                `).join('');
                document.getElementById('anomalies').innerHTML = html;
            } catch (e) {
                document.getElementById('anomalies').innerHTML = `<p class="empty">Error: ${e.message}</p>`;
            }
        }

        async function dismissAnomaly(anomalyId) {
            try {
                const r = await fetch(`${API_BASE}/api/health/issues/dismiss`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({issue_id: anomalyId})
                });
                const result = await r.json();
                if (result.success) {
                    await loadAnomalies();
                    await loadHealthOverview(); // Update issue counts
                } else {
                    alert('Failed to dismiss: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed to dismiss: ' + e.message);
            }
        }

        async function loadPreferences() {
            try {
                const r = await fetch(`${API_BASE}/api/patterns/preferences`);
                const data = await r.json();
                const prefs = data.preferences || [];

                if (prefs.length === 0) {
                    document.getElementById('preferences').innerHTML = '<p class="empty">No learned preferences yet</p>';
                    return;
                }

                const html = '<table><tr><th>Pattern</th><th>Destination</th><th>Confidence</th><th>Count</th></tr>' +
                    prefs.slice(0, 10).map(p => `
                        <tr>
                            <td>${p.pattern_value}</td>
                            <td>${p.destination}</td>
                            <td>${(p.confidence * 100).toFixed(0)}%</td>
                            <td>${p.occurrences}</td>
                        </tr>
                    `).join('') + '</table>';
                document.getElementById('preferences').innerHTML = html;
            } catch (e) {
                document.getElementById('preferences').innerHTML = `<p class="empty">Error: ${e.message}</p>`;
            }
        }

        async function loadSuggestions() {
            try {
                const r = await fetch(`${API_BASE}/api/patterns/suggestions`);
                const data = await r.json();
                const suggestions = data.suggestions || [];

                if (suggestions.length === 0) {
                    document.getElementById('suggestions').innerHTML = '<p class="empty">No suggestions yet</p>';
                    return;
                }

                const html = suggestions.map(s => `
                    <div class="suggestion">
                        ${s.rule}<br>
                        <span class="timestamp">Confidence: ${(s.confidence * 100).toFixed(0)}% (${s.based_on})</span>
                        <button onclick="confirmRule('${s.pattern_type}', '${s.pattern_value}', '${s.destination}')">Confirm</button>
                    </div>
                `).join('');
                document.getElementById('suggestions').innerHTML = html;
            } catch (e) {
                document.getElementById('suggestions').innerHTML = `<p class="empty">Error: ${e.message}</p>`;
            }
        }

        async function confirmRule(patternType, patternValue, destination) {
            if (!confirm(`Confirm rule: ${patternValue} ‚Üí ${destination}?`)) return;

            try {
                await fetch(`${API_BASE}/api/patterns/confirm_rule`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({pattern_type: patternType, pattern_value: patternValue, destination: destination})
                });
                loadSuggestions();
                loadPreferences();
            } catch (e) {
                alert('Failed to confirm rule: ' + e.message);
            }
        }

        async function loadNodeHealth() {
            try {
                const r = await fetch(`${API_BASE}/api/health/nodes`);
                const data = await r.json();
                const nodes = data.nodes || {};

                if (Object.keys(nodes).length === 0) {
                    document.getElementById('node-health').innerHTML = '<p class="empty">No nodes found</p>';
                    return;
                }

                const html = '<table><tr><th>Node</th><th>Status</th><th>Message</th><th>Last Update</th></tr>' +
                    Object.entries(nodes).map(([node, health]) => {
                        const statusIcon = health.status === 'healthy' ? '‚úì' : health.status === 'stale' ? '‚ö†' : '‚úó';
                        const statusColor = health.status === 'healthy' ? '#00ff00' : health.status === 'stale' ? '#ffaa00' : '#ff0000';
                        return `
                            <tr>
                                <td>${node}</td>
                                <td style="color: ${statusColor}">${statusIcon} ${health.status}</td>
                                <td>${health.message}</td>
                                <td class="timestamp">${health.last_update ? new Date(health.last_update).toLocaleString() : 'N/A'}</td>
                            </tr>
                        `;
                    }).join('') + '</table>';
                document.getElementById('node-health').innerHTML = html;
            } catch (e) {
                document.getElementById('node-health').innerHTML = `<p class="empty">Error: ${e.message}</p>`;
            }
        }

        async function loadQueueHealth() {
            try {
                const r = await fetch(`${API_BASE}/api/health/queues`);
                const data = await r.json();
                const queues = data.queues || {};

                if (Object.keys(queues).length === 0) {
                    document.getElementById('queue-health').innerHTML = '<p class="empty">No queues found</p>';
                    return;
                }

                const html = Object.entries(queues).map(([queue, health]) => {
                    const statusIcon = health.status === 'healthy' ? '‚úì' : '‚ö†';
                    const statusColor = health.status === 'healthy' ? '#00ff00' : '#ffaa00';

                    // Add action buttons for stages with files
                    let actions = '';
                    if (health.count > 0 && queue !== 'dump' && queue !== 'clear') {
                        actions = `
                            <button style="margin-left: 10px; padding: 3px 10px; font-size: 11px;" onclick="retryQueue('${queue}')">Retry All</button>
                            <button style="margin-left: 5px; padding: 3px 10px; font-size: 11px;" onclick="clearQueue('${queue}')">Clear</button>
                        `;
                    }

                    return `
                        <div class="metric">
                            <span><span style="color: ${statusColor}">${statusIcon}</span> ${queue}</span>
                            <span>${health.count} files${actions}</span>
                        </div>
                    `;
                }).join('');
                document.getElementById('queue-health').innerHTML = html;
            } catch (e) {
                document.getElementById('queue-health').innerHTML = `<p class="empty">Error: ${e.message}</p>`;
            }
        }

        async function retryQueue(stage) {
            if (!confirm(`Move all files from ${stage} back to dump for retry?`)) return;

            try {
                const r = await fetch(`${API_BASE}/api/intake/retry/${stage}`, {method: 'POST'});
                const result = await r.json();
                if (result.success) {
                    alert(`${result.files_retried} files moved back to dump`);
                    await loadQueueHealth();
                } else {
                    alert('Failed to retry: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed to retry: ' + e.message);
            }
        }

        async function clearQueue(stage) {
            if (!confirm(`Clear all files from ${stage}? (moves to clear stage)`)) return;

            try {
                const r = await fetch(`${API_BASE}/api/intake/clear/${stage}`, {method: 'POST'});
                const result = await r.json();
                if (result.success) {
                    alert(`${result.files_cleared} files cleared`);
                    await loadQueueHealth();
                } else {
                    alert('Failed to clear: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed to clear: ' + e.message);
            }
        }

        async function loadAPIHealth() {
            try {
                const r = await fetch(`${API_BASE}/api/health/apis`);
                const data = await r.json();
                const apis = data.apis || {};

                if (Object.keys(apis).length === 0) {
                    document.getElementById('api-health').innerHTML = '<p class="empty">No APIs configured</p>';
                    return;
                }

                const html = Object.entries(apis).map(([api, health]) => {
                    const statusIcon = health.status === 'healthy' ? '‚úì' : health.status === 'degraded' ? '‚ö†' : '‚úó';
                    const statusColor = health.status === 'healthy' ? '#00ff00' : health.status === 'degraded' ? '#ffaa00' : '#ff0000';
                    const latency = health.latency_ms ? ` (${health.latency_ms}ms)` : '';
                    return `
                        <div class="metric">
                            <span><span style="color: ${statusColor}">${statusIcon}</span> ${api}</span>
                            <span>${health.message}${latency}</span>
                        </div>
                    `;
                }).join('');
                document.getElementById('api-health').innerHTML = html;
            } catch (e) {
                document.getElementById('api-health').innerHTML = `<p class="empty">Error: ${e.message}</p>`;
            }
        }

        async function loadProviderMesh() {
            try {
                const r = await fetch(`${API_BASE}/api/health/providers`);
                const data = await r.json();
                const providers = data.providers || {};

                if (Object.keys(providers).length === 0) {
                    document.getElementById('provider-mesh').innerHTML = '<p class="empty">No provider health data yet</p>';
                    return;
                }

                const html = '<table><tr><th>Provider</th><th>Status</th><th>Success Rate</th><th>Requests</th><th>Failures</th><th>Actions</th></tr>' +
                    Object.entries(providers).map(([name, p]) => {
                        const statusIcon = p.status === 'healthy' ? '[OK]' : p.status === 'degraded' ? '[!]' : p.status === 'blacklisted' ? '[X]' : '[?]';
                        const statusColor = p.status === 'healthy' ? '#00ff00' : p.status === 'degraded' ? '#ffaa00' : '#ff0000';

                        let actions = '';
                        if (p.status === 'blacklisted') {
                            const until = p.blacklisted_until ? new Date(p.blacklisted_until) : null;
                            const remaining = until ? Math.max(0, (until - new Date()) / 60000).toFixed(1) : 0;
                            actions = `<button onclick="unblacklistProvider('${name}')">Unblock (${remaining}min left)</button>`;
                        } else if (p.status === 'degraded' || p.consecutive_failures > 0) {
                            actions = `<button onclick="resetProviderHealth('${name}')">Reset Health</button>`;
                        }

                        return `
                            <tr>
                                <td>${name}</td>
                                <td style="color: ${statusColor}">${statusIcon} ${p.status}</td>
                                <td>${p.success_rate.toFixed(1)}%</td>
                                <td>${p.total_requests}</td>
                                <td>${p.consecutive_failures}</td>
                                <td>${actions}</td>
                            </tr>
                        `;
                    }).join('') + '</table>';
                document.getElementById('provider-mesh').innerHTML = html;
            } catch (e) {
                document.getElementById('provider-mesh').innerHTML = `<p class="empty">Error: ${e.message}</p>`;
            }
        }

        async function unblacklistProvider(provider) {
            if (!confirm(`Unblacklist ${provider} now?`)) return;

            try {
                const r = await fetch(`${API_BASE}/api/health/providers/unblacklist`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({provider: provider})
                });
                const result = await r.json();
                if (result.success) {
                    await loadProviderMesh();
                } else {
                    alert('Failed to unblacklist: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed to unblacklist: ' + e.message);
            }
        }

        async function resetProviderHealth(provider) {
            if (!confirm(`Reset health counters for ${provider}?`)) return;

            try {
                const r = await fetch(`${API_BASE}/api/health/providers/reset`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({provider: provider})
                });
                const result = await r.json();
                if (result.success) {
                    await loadProviderMesh();
                } else {
                    alert('Failed to reset health: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed to reset health: ' + e.message);
            }
        }

        async function loadCardSummaries() {
            console.log('[DEBUG] loadCardSummaries starting...');

            // Provider summary
            try {
                console.log('[DEBUG] Fetching providers...');
                const r = await fetch(`${API_BASE}/api/health/providers`);
                const data = await r.json();
                console.log('[DEBUG] Provider data:', data);
                const providers = data.providers || {};
                const healthy = Object.values(providers).filter(p => p.status === 'healthy').length;
                const degraded = Object.values(providers).filter(p => p.status === 'degraded').length;
                const blacklisted = Object.values(providers).filter(p => p.status === 'blacklisted').length;
                document.getElementById('provider-summary').innerHTML = `${healthy} healthy, ${degraded} degraded, ${blacklisted} blacklisted`;
                console.log('[DEBUG] Provider summary updated');
            } catch(e) {
                console.error('[ERROR] Provider summary failed:', e);
                document.getElementById('provider-summary').innerHTML = 'Error: ' + e.message;
            }

            // Queue summary
            try {
                const r = await fetch(`${API_BASE}/api/health/queues`);
                const data = await r.json();
                const queues = data.queues || {};
                const totalFiles = Object.values(queues).reduce((sum, q) => sum + q.count, 0);
                const queueCount = Object.keys(queues).length;
                document.getElementById('queue-summary').innerHTML = `${totalFiles} files in ${queueCount} queues`;
            } catch(e) { document.getElementById('queue-summary').innerHTML = 'Error loading'; }

            // Node summary
            try {
                const r = await fetch(`${API_BASE}/api/health/nodes`);
                const data = await r.json();
                const nodes = data.nodes || {};
                const healthy = Object.values(nodes).filter(n => n.status === 'healthy').length;
                const noDb = Object.values(nodes).filter(n => n.status === 'no_db').length;
                document.getElementById('node-summary').innerHTML = `${healthy} healthy, ${noDb} no_db`;
            } catch(e) { document.getElementById('node-summary').innerHTML = 'Error loading'; }

            // Learning summary
            try {
                const r = await fetch(`${API_BASE}/api/patterns/preferences`);
                const data = await r.json();
                const prefs = data.preferences || [];
                document.getElementById('learning-summary').innerHTML = `${prefs.length} routes learned`;
            } catch(e) { document.getElementById('learning-summary').innerHTML = 'Error loading'; }

            // Rules summary
            try {
                const r = await fetch(`${API_BASE}/api/patterns/suggestions`);
                const data = await r.json();
                const suggestions = data.suggestions || [];
                document.getElementById('rules-summary').innerHTML = `${suggestions.length} rules suggested`;
            } catch(e) { document.getElementById('rules-summary').innerHTML = 'Error loading'; }

            // Pattern summary
            try {
                const r = await fetch(`${API_BASE}/api/patterns/stats`);
                const data = await r.json();
                document.getElementById('pattern-summary').innerHTML = `${data.total_routings || 0} total routings`;
            } catch(e) { document.getElementById('pattern-summary').innerHTML = 'Error loading'; }
        }

        function openModal(type) {
            // Create overlay
            let overlay = document.getElementById('modal-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'modal-overlay';
                overlay.className = 'modal-overlay';
                overlay.onclick = (e) => { if (e.target === overlay) closeModal(); };
                document.body.appendChild(overlay);
            }

            // Create modal content
            const modal = document.createElement('div');
            modal.className = 'modal-content';
            modal.innerHTML = `
                <div class="modal-header">
                    <h2 class="modal-title">${getModalTitle(type)}</h2>
                    <button class="modal-close" onclick="closeModal()">‚úï Close</button>
                </div>
                <div class="modal-body" id="modal-body-${type}">
                    Loading...
                </div>
            `;
            overlay.appendChild(modal);
            overlay.classList.add('show');

            // Load modal content
            loadModalContent(type);
        }

        function closeModal() {
            const overlay = document.getElementById('modal-overlay');
            if (overlay) {
                overlay.innerHTML = '';
                overlay.classList.remove('show');
            }
        }

        function getModalTitle(type) {
            const titles = {
                'providers': 'üåê Provider Mesh Details',
                'queues': 'üì• Queue Management',
                'nodes': 'üå≥ Node Health & Database Management',
                'learning': 'üß† Learned Routing Patterns',
                'rules': 'üí° Suggested Routing Rules',
                'patterns': 'üìä Pattern Recognition Stats'
            };
            return titles[type] || type;
        }

        async function loadModalContent(type) {
            const bodyEl = document.getElementById(`modal-body-${type}`);

            try {
                switch(type) {
                    case 'providers':
                        await loadProvidersModal(bodyEl);
                        break;
                    case 'queues':
                        await loadQueuesModal(bodyEl);
                        break;
                    case 'nodes':
                        await loadNodesModal(bodyEl);
                        break;
                    case 'learning':
                        await loadLearningModal(bodyEl);
                        break;
                    case 'rules':
                        await loadRulesModal(bodyEl);
                        break;
                    case 'patterns':
                        await loadPatternsModal(bodyEl);
                        break;
                    default:
                        bodyEl.innerHTML = '<p>Unknown modal type</p>';
                }
            } catch (e) {
                bodyEl.innerHTML = `<p class="empty">Error loading: ${e.message}</p>`;
            }
        }

        // Modal content loaders
        async function loadNodesModal(el) {
            const r = await fetch(`${API_BASE}/api/health/nodes`);
            const data = await r.json();
            const nodes = data.nodes || {};

            if (Object.keys(nodes).length === 0) {
                el.innerHTML = '<p class="empty">No nodes found</p>';
                return;
            }

            let html = '<table style="width: 100%;"><tr><th>Node</th><th>Status</th><th>Message</th><th>Actions</th></tr>';
            for (const [nodeName, node] of Object.entries(nodes)) {
                const statusColor = node.status === 'healthy' ? '#00ff00' : node.status === 'no_db' ? '#ff0000' : '#ffaa00';
                const statusIcon = node.status === 'healthy' ? '‚úì' : node.status === 'no_db' ? '‚úó' : '‚ö†';

                let actions = '';
                if (node.status === 'no_db') {
                    actions += \`<button onclick="createNodeDB('\${nodeName}')" style="margin-right: 5px;">Create Database</button>\`;
                }
                actions += \`<button onclick="viewNodeFiles('\${nodeName}')">View Files</button>\`;

                html += \`
                    <tr>
                        <td>\${nodeName}</td>
                        <td style="color: \${statusColor}">\${statusIcon} \${node.status}</td>
                        <td>\${node.message}</td>
                        <td>\${actions}</td>
                    </tr>
                \`;
            }
            html += '</table>';
            el.innerHTML = html;
        }

        async function createNodeDB(nodeName) {
            if (!confirm(\`Create knowledge database for node '\${nodeName}'?\`)) return;
            alert('Creating database... (to be wired to backend)');
            // TODO: Wire to /api/nodes/create_db endpoint
        }

        async function viewNodeFiles(nodeName) {
            alert(\`Viewing files for '\${nodeName}'... (to be implemented)\`);
            // TODO: Show file list modal
        }

        async function loadProvidersModal(el) { el.innerHTML = 'Provider details coming soon...'; }
        async function loadQueuesModal(el) { el.innerHTML = 'Queue details coming soon...'; }
        async function loadLearningModal(el) { el.innerHTML = 'Learning details coming soon...'; }
        async function loadRulesModal(el) { el.innerHTML = 'Rules details coming soon...'; }
        async function loadPatternsModal(el) { el.innerHTML = 'Pattern details coming soon...'; }

        async function loadAll() {
            updateTimestamp();
            await loadCardSummaries();
        }

        // Load on page load
        loadAll();

        // Auto-refresh every 30 seconds
        setInterval(loadAll, 30000);
    </script>
</body>
</html>
